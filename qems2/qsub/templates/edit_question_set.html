{% extends "base.html" %}

{% block header %}
{% include "header.html" %}
{% endblock %}

{% block sidebar %}
{% include "sidebar.html" %}
{% endblock %}

{% block content %}
{% load static %}
{% load filters %}
{% load comments %}
{% if active_tab == 'qset_info' %} {{ 'active' }} {% endif %}
<div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 text-left">
    <h2 class="page-header">Question Set Management</h2>

    <div class="tabbable">
		<ul class="nav nav-tabs">
			<li class="active dropdown">
				<a href="#qset-info" data-toggle="tab">Question set info</a>
			</li>
			<li>
				<a href="#editors" data-toggle="tab">Editor assignments</a>
			</li>
            <li>
                <a href="#set-wide-distribution" data-toggle="tab">Set-wide distribution</a>
            </li>
            <li>
                <a href="#questions" data-toggle="tab">Questions</a>
            </li>
            <li>
				<a href="#packets" data-toggle="tab">Packets</a>
			</li>
		</ul>
		<div class="tab-content">
			<div class="tab-pane active" id="qset-info">
                {% if message %}
				<p>
					<div class="alert {{ message_class }}">
						{{ message }}
					</div>
				</p>
				{% endif %}
				<div class="alert alert-info" style="text-align: center;"><strong>Set information</strong></div>
				<form action="" method="post">
					{% csrf_token %}
					{{ form.as_p }}
					{% if not read_only %}
					<input type="submit" value="Submit changes"/>
					{% endif %}
				</form>
                <a id="#qset-status"></a>
                <div class="alert alert-info" style="text-align: center"><strong>Set Status</strong></div>

                <a id="#qset-comments"></a>
                <div class="alert alert-info" style="text-align: center"><strong>Comments</strong></div>
                <div class="comments col-md-6">
                    {% render_comment_list for qset %}
                    {% get_comment_form for qset as cform %}
                    <form action="{% comment_form_target %}" method="POST">
                        {% csrf_token %}
                        {{ cform.comment.label_tag }}
                        <textarea cols="40" rows="10" id="{{ cform.comment.id_for_label }}"
                                  name="{{ cform.comment.html_name }}" class="form-control">
                        </textarea>
                        {{ cform.honeypot }}
                        {{ cform.content_type }}
                        {{ cform.object_pk }}
                        {{ cform.timestamp }}
                        {{ cform.security_hash }}
                        <input type="submit" name="submit" value="Post" class="btn btn-primary">
                        <!--<input type="submit" name="preview" value="Preview" class="btn btn-primary">-->
                        <input type="hidden" name="next" value="/edit_question_set/{{ qset.id }}/">
                    </form>
                </div>


                <!--<button class="btn btn-primary comment-button" title="Leave Comment">Comment</button>-->

			</div>
			<div class="tab-pane" id="editors">
				{% if not read_only %}
                <a href="/add_editor/{{ qset.id }}" class="btn btn-primary" title="Add set editor" id="btn-add-editor">
					<i class="fa fa-plus-circle"></i> Add set editor
				</a>
                <a href="/add_writer/{{ qset.id }}" class="btn btn-primary" title="Add set writer">
					<i class="fa fa-plus-circle"></i> Add set writer
				</a>
				<table class="table table-striped table-hover">
					<caption class="alert alert-info">
						<strong>Current set editors</strong>
					</caption>
					<thead>
						<tr>
							<th>Editor name</th>
							<th>Editor username</th>
							<th>Categories</th>
							<th>Actions</th>
						</tr>
					</thead>
					<tbody>
						{% for editor in editors %}
						<tr>
							<td>{{ editor.user.first_name }} {{ editor.user.last_name }}</td>
							<td>{{ editor.user.username }}</td>
							<td></td>
							<td><a href="/roleassign/{{ editor.id }}/{{ tour.id}}/" rel="tooltip" title="Assign categories">
								<i class="fa fa-edit"></i>
								</a><a href="/removeeditor/{{ tour.id }}/{{ editor.id }}/" rel="tooltip" title="Remove editor">
									<i class="fa fa-minus-circle"></i> </a>
							</td>
						</tr>
						{% endfor %}
					</tbody>
				</table>

                <table class="table table-striped table-hover">
					<caption class="alert alert-info">
						<strong>Current set writers</strong>
					</caption>
					<thead>
						<tr>
							<th>Writer name</th>
							<th>Writer username</th>
							<th>Actions</th>
						</tr>
					</thead>
					<tbody>
						{% for writer in writers %}
						<tr>
							<td>{{ writer.user.first_name }} {{ writer.user.last_name }}</td>
							<td>{{ writer.user.username }}</td>
							<td><i class="fa fa-edit"></i>
								</a><a href="/removeeditor/{{ tour.id }}/{{ editor.id }}/" rel="tooltip" title="Remove writer">
									<i class="fa fa-minus-circle"></i> </a>
							</td>
						</tr>
						{% endfor %}
					</tbody>
				</table>
				{% else %}
				<div class="alert alert-info">
					You are not authorized to view this information
				</div>

				{% endif %}
			</div>
            <div class="tab-pane" id="set-wide-distribution">
                <div class="alert alert-warning">
                    <i class="fa fa-exclamation-triangle" style="font-size: 24px"></i>
                    The set-wide distribution controls the total number of questions of each kind that your set
                    will contain. It is distinct from the "template" distribution; you cannot change the categories
                    this way, only the <em>total</em> number of questions in those categories that will appear in
                    this set. For example, if the ACF distribution calls for a minimum of 1 and a maximum of 2
                    social science questions per packet, and you have 10 packets in your set, then any number
                    between 10 and 20 social science questions might appear in your set unless you restrict it here,
                    e.g. by setting the maximum allowed number of such questions to 15. Setting these values is
                    crucial for the packet-level and set-level verification algorithms to work, so don't skip this section!

                </div>
                <form action="/edit_set_distribution/{{ qset.id }}/" method="POST">
                    {% csrf_token %}
                    <table class="table table-striped table-hover">
                        <caption class="alert alert-info">
                            <strong>Set-wide Requirements</strong>
                        </caption>
                        <thead>
                        <th>Category</th>
                        <th>Subcategory</th>
                        <th>Total Tossups (per set)</th>
                        <th>Total Bonuses (per set)</th>
                        </thead>
                        <tbody>
                        {% for entry in set_distro_formset %}
                        <tr>
                            <input type="hidden" value="{{ entry.initial.entry_id }}" name="{{ entry.entry_id.html_name }}">
                            <!--<input type="hidden" value="{{ entry.initial.dist_entry.id }}" name="{{ entry.dist_entry.html_name}}">-->
                            <td>{{ entry.category.value }}</td>
                            <td>{{ entry.subcategory.value }}</td>
                            <td>{{ entry.num_tossups }}</td>
                            <td>{{ entry.num_bonuses }}</td>
                        </tr>
                        {% endfor %}
                    </table>
                    <input type="submit" class="btn btn-primary">
                    {{ set_distro_formset.management_form }}
                </form>
            </div>
            <div class="tab-pane" id="questions">
                <a href="/add_tossups/{{ qset.id }}" class="btn btn-primary" title="Add tossups">
                    <i class="fa fa-plus-circle"></i> Add tossups
                </a>
                <a href="/add_bonuses/{{ qset.id }}" class="btn btn-primary" title="Add bonuses">
                    <i class="fa fa-plus-circle"></i> Add bonuses
                </a>
                <a href="#" class="btn btn-primary" title="Upload questions" id="upload-questions">
                    <i class="fa fa-upload"></i> Upload questions from file
                </a>
                <table class="table table-striped table-hover">
                    <caption class="alert alert-info">
                        <strong>
                            Current Tossups
                        </strong>
                    </caption>
                    <thead>
                    <tr>
                        <th>Tossup Text</th>
                        <th>Answer</th>
                        <th>Category</th>
                        <th>Packet</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for tossup in tossups %}
                    <tr>
                        <td>{{ tossup.tossup_text|preview }}</td>
                        <td>{{ tossup.tossup_answer|preview }}</td>
                        <td>{{ tossup.category }}</td>
                        <td>{% if tossup.packet %} {{ tossup.packet }} {% else %} Not in packet {% endif %}</td>
                        <td>
                            <a href="/edit_tossup/{{ tossup.id }}" rel="tooltip" title="Edit tossup">
                                <i class="fa fa-edit"></i>
                            </a>
                            <a href="/delete_tossup/{{ tossup.id }}" rel="tooltip" title="Delete tossup" class="delete_tossup" value="{{ tossup.id }}">
                                <i class="fa fa-minus-circle"></i>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
                <table class="table table-striped table-hover">
                    <caption class="alert alert-info">
                        <strong>
                            Current Bonuses
                        </strong>
                    </caption>
                    <thead>
                    <tr>
                        <th>Leadin</th>
                        <th>Answers</th>
                        <th>Category</th>
                        <th>Packet</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for bonus in bonuses %}
                    <tr>
                        <td>{{ bonus.leadin|preview }}</td>
                        <td>{{ bonus|bonus_answers }}</td>
                        <td>{{ bonus.category }}</td>
                        <td>{% if bonus.packet %} {{ bonus.packet }} {% else %} Not in packet {% endif %}</td>
                        <td>
                            <a href="/edit_bonus/{{ bonus.id }}" rel="tooltip" title="Edit tossup">
                                <i class="fa fa-edit"></i>
                            </a>
                            <a href="/delete_bonus/{{ bonus.id }}" rel="tooltip" title="Delete bonus" class="delete_bonus" value="{{ bonus.id }}">
                                <i class="fa fa-minus-circle"></i>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
			<div class="tab-pane" id="packets">
                <a href="/add_packets/{{ qset.id }}" class="btn btn-primary" title="Add packets">
                    <i class="fa fa-plus-circle"></i> Add packets
                </a>
				<table class="table table-striped table-hover">
					<caption class="alert alert-info">
						<strong>
							Active packets
						</strong>
					</caption>
					<thead>
						<tr>
							<th>Packet name</th>
							<th>Completion status</th>
							<th>Actions</th>
						</tr>
					</thead>
					<tbody>
						{% for packet in packets %}
                        <tr>
                            <td>
                                {% if not read_only %}
                                <a href="/edit_packet/{{ packet.id }}">{{ packet.packet_name }}</a>
                                {% else %}
                                {{ packet.packet_name }}
                                {% endif %}
                            </td>
                            <td>
                                N/A
                            </td>
                            <td>
                                <a href="/delete_packet/{{ packet.id }}" rel="tooltip" title="Delete packet" class="delete_packet" value="{{ packet.id }}">
                                <i class="fa fa-minus-circle"></i>
                            </a>
                            </td>
                        </tr>
						{% endfor %}
					</tbody>
				</table>
			</div>
		</div>
	</div>
</div>

<input type="hidden" id="qset-id" value="{{ qset.id }}">
<script type="text/javascript" src="{% static 'js/comments.js' %}"></script>

{% include "dialog.html" %}

<!--<div id="comment-dialog" style="display: none">
    <div class="comment-header">

    </div>
    <div class="comment-content">
        <form action="/add_comment/" method="post" class="form-horizontal">
            {% csrf_token %}
            <input type="hidden" id="reply-to" name="reply-to" value="">
            <input type="hidden" id="qset-id" name="qset-id" value="{{ qset.id }}">
            <textarea rows="10" cols="64" id="comment-text" name="comment-text"></textarea>
        </form>
    </div>
</div>-->


<div id="upload-dialog" >
    <form action="/upload_questions/{{ qset.id }}/" method="POST" enctype="multipart/form-data">
        {% csrf_token %}
        {{ upload_form }}
    </form>
</div>

{% endblock %}
